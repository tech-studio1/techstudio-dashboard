"use client";

import { useEffect, useState } from "react";
import { IconChevronsLeft, IconMenu2, IconX } from "@tabler/icons-react";
import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import Nav from "@/components/layouts/nav";
import { sidelinks } from "@/lib/data/sidelinks";
import { Layout } from "@/components/layouts/layout";
import Link from "next/link";

interface SidebarProps extends React.HTMLAttributes<HTMLElement> {
  isCollapsed: boolean;
  setIsCollapsed: React.Dispatch<React.SetStateAction<boolean>>;
  permissions: string[];
}

export default function Sidebar({
  className,
  isCollapsed,
  setIsCollapsed,
  permissions,
}: SidebarProps) {
  const [navOpened, setNavOpened] = useState(false);

  /* Make body not scrollable when navBar is opened */
  useEffect(() => {
    if (navOpened) {
      document.body.classList.add("overflow-hidden");
    } else {
      document.body.classList.remove("overflow-hidden");
    }
  }, [navOpened]);

  // Filter links based on permissions
  const filteredLinks = sidelinks.filter((link) => {
    // Always show the "Dashboard" link
    if (link.key === "DASHBOARD") return true;

    // If permissions include "ALL", show all links
    if (permissions.includes("ALL")) return true;

    // Otherwise, check if the link's key is in the permissions array
    return permissions.includes(link.key || "");
  });

  return (
    <aside
      className={cn(
        `fixed left-0 right-0 top-0 z-50 w-full border-r-2 border-r-muted transition-[width] md:bottom-0 md:right-auto md:h-svh ${
          isCollapsed ? "md:w-14" : "md:w-64"
        }`,
        className
      )}
    >
      {/* Overlay in mobile */}
      <div
        onClick={() => setNavOpened(false)}
        className={`absolute inset-0 transition-[opacity] delay-100 duration-700 ${
          navOpened ? "h-svh opacity-50" : "h-0 opacity-0"
        } w-full bg-black md:hidden`}
      />

      <Layout fixed className={navOpened ? "h-svh" : ""}>
        {/* Header */}
        <Layout.Header
          sticky
          className="z-50 flex justify-between px-2 py-3 shadow-sm md:px-2"
        >
          <div>
            <Link
              href="/"
              className={`flex items-center ${!isCollapsed ? "gap-2" : ""}`}
            >
              {/* Logo */}
              <svg
                width="42"
                height="30"
                viewBox="0 0 42 30"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M28.8688 3.83032L28.5432 5.92116L27.8234 10.5313L27.6606 11.551L26.1867 20.4884L26.1524 20.7198L25.1156 26.8723L18.0376 30L21.7223 6.08397C24.1644 5.31276 26.5894 4.54155 28.8688 3.83032Z"
                  fill="#1878FF"
                />
                <mask
                  id="mask0_7_41"
                  maskUnits="userSpaceOnUse"
                  x="0"
                  y="0"
                  width="42"
                  height="21"
                >
                  <path
                    d="M28.8689 3.83034C25.4584 4.90146 21.7309 6.07541 18.1234 7.22366C8.72322 10.2057 0.128535 12.9735 0 13.0249C6.75236 12.168 12.7249 11.5767 17.4893 11.1483C22.3222 10.7112 26.0069 10.4199 27.8749 10.1885H27.8835L26.1354 20.7455L26.1611 20.7198L41.4653 0.00856886L41.4739 0C39.7172 0.462725 34.7644 1.97944 28.8689 3.83034Z"
                    fill="white"
                  />
                </mask>
                <g mask="url(#mask0_7_41)">
                  <path
                    d="M49.0061 17.5236L6.45255 35.7755L-7.51489 3.22194L35.0301 -15.0386L49.0061 17.5236Z"
                    fill="url(#paint0_linear_7_41)"
                  />
                </g>
                <defs>
                  <linearGradient
                    id="paint0_linear_7_41"
                    x1="41.5863"
                    y1="1.43676"
                    x2="15.3942"
                    y2="12.6732"
                    gradientUnits="userSpaceOnUse"
                  >
                    <stop stopColor="#17A2FF" />
                    <stop offset="1" stopColor="#2654FF" />
                  </linearGradient>
                </defs>
              </svg>

              <div
                className={`flex flex-col justify-end truncate ${
                  isCollapsed ? "invisible w-0" : "visible w-auto"
                }`}
              >
                {/* Logo Text */}
                <svg
                  width="180"
                  height="23"
                  viewBox="0 0 180 23"
                  className="fill-black dark:fill-white"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path d="M9.22852 2.47936H0V0.0125732H20.9363V2.47936H11.7078V22.6644H9.22852V2.47936Z" />
                  <path d="M26.7588 18.9955C27.1469 19.3586 27.5977 19.6591 28.0986 19.872C28.5995 20.0849 29.1504 20.1976 29.7264 20.1976H38.3789V22.6769H29.7264C28.7748 22.6769 27.8857 22.5016 27.0468 22.1384C26.2078 21.7753 25.4815 21.287 24.868 20.6484C24.2419 20.0223 23.7535 19.2835 23.4029 18.4445C23.0398 17.6056 22.8645 16.7291 22.8645 15.7899V11.3322C22.8645 10.3805 23.0398 9.49149 23.4029 8.65253C23.7661 7.81358 24.2544 7.08732 24.868 6.44871C25.4941 5.82262 26.2203 5.32175 27.0468 4.9461C27.8857 4.58297 28.7748 4.39514 29.7264 4.39514H34.2342C35.2986 4.39514 36.1751 4.63305 36.8513 5.10888C37.5275 5.58471 37.9782 6.17323 38.1786 6.88697C38.3789 7.60071 38.3414 8.35201 38.0659 9.1534C37.7904 9.95479 37.2269 10.6936 36.388 11.3572L26.7588 18.9955ZM25.3313 15.6146C25.3313 15.8275 25.3563 16.0278 25.3939 16.2282C25.4315 16.416 25.4941 16.5913 25.5692 16.7291L34.8854 9.45393C35.236 9.17845 35.4864 8.89045 35.6367 8.58992C35.7869 8.2894 35.8495 8.01393 35.7995 7.76349C35.7494 7.51306 35.5991 7.30019 35.3487 7.1374C35.0982 6.97462 34.7226 6.88697 34.2468 6.88697H29.7389C29.1128 6.88697 28.5368 6.99966 28.0109 7.23758C27.4725 7.47549 27.0217 7.78853 26.6335 8.18923C26.2454 8.58992 25.9323 9.05323 25.7069 9.60419C25.469 10.1426 25.3563 10.7311 25.3563 11.3572V15.6146H25.3313Z" />
                  <path d="M42.9997 8.56483C43.3628 7.72587 43.8637 6.99961 44.5023 6.38605C45.1284 5.75996 45.8797 5.27161 46.7312 4.921C47.5827 4.55787 48.4968 4.38257 49.4735 4.38257H57.5625V6.86187H49.4735C48.8348 6.86187 48.2338 6.97457 47.6828 7.21248C47.1319 7.45039 46.6435 7.76344 46.2428 8.16413C45.8296 8.56483 45.5166 9.02813 45.2787 9.55405C45.0408 10.08 44.9281 10.6434 44.9281 11.2445V17.9311C44.9281 18.5572 45.166 19.0831 45.6293 19.5339C46.0926 19.9847 46.6686 20.21 47.3448 20.21H57.5625V22.6894H47.3448C46.6686 22.6894 46.03 22.5641 45.4289 22.3137C44.8279 22.0633 44.302 21.7252 43.8762 21.2994C43.438 20.8737 43.0999 20.3728 42.8369 19.7843C42.5865 19.1958 42.4613 18.5947 42.4613 17.9561V11.2946C42.4488 10.2928 42.6366 9.40379 42.9997 8.56483Z" />
                  <path d="M73.3147 4.88353C74.1286 5.2091 74.8298 5.63484 75.4308 6.19831C76.0319 6.74927 76.5077 7.4004 76.8583 8.16423C77.2089 8.91553 77.3842 9.72944 77.3842 10.5809V17.6056H74.9049V10.5809C74.9049 10.0801 74.7922 9.60423 74.5668 9.15344C74.3414 8.70266 74.0409 8.31449 73.6653 7.9764C73.2896 7.63831 72.8514 7.37536 72.338 7.17501C71.8371 6.98718 71.2862 6.88701 70.7102 6.88701H64.4493V22.6644H61.97V0.0125732H64.4493V4.4077H70.6976C71.6367 4.4077 72.5008 4.57049 73.3147 4.88353Z" />
                  <path d="M92.1724 12.359C93.0865 12.8223 93.8003 13.3983 94.3137 14.087C94.827 14.7757 95.1526 15.5019 95.3029 16.2532C95.4531 17.0045 95.4281 17.7683 95.2277 18.5447C95.0274 19.3085 94.6768 19.9972 94.1634 20.6108C93.65 21.2243 92.9864 21.7127 92.185 22.1009C91.3836 22.4765 90.4444 22.6643 89.3801 22.6643L74.9175 22.6894V20.2101L89.3801 20.185C90.2691 20.185 91.0204 19.9722 91.6215 19.559C92.2225 19.1457 92.6232 18.6323 92.811 18.0438C92.9989 17.4553 92.9613 16.8417 92.6858 16.1906C92.4104 15.552 91.8343 15.001 90.9829 14.5628L81.842 9.84209C80.9655 9.3913 80.2768 8.84035 79.7759 8.1767C79.275 7.51304 78.937 6.82435 78.7867 6.08557C78.6364 5.34678 78.6364 4.62052 78.8117 3.90678C78.987 3.19304 79.3251 2.54191 79.8135 1.95339C80.3143 1.37739 80.953 0.901566 81.7543 0.538435C82.5557 0.175305 83.4824 0 84.5467 0H94.2135V2.4793H84.5467C83.6326 2.4793 82.8938 2.67965 82.3178 3.0553C81.7418 3.44348 81.3787 3.90678 81.2284 4.45774C81.0782 4.99617 81.1408 5.57217 81.4163 6.1607C81.6917 6.74922 82.2302 7.25009 83.0065 7.66331L92.1724 12.359Z" />
                  <path d="M102.365 19.0456C103.004 19.7969 104.168 20.1851 105.859 20.1851H110.517V22.6644H105.859C103.429 22.6644 101.651 22.0634 100.512 20.8487C99.3724 19.6341 98.8089 17.7058 98.8089 15.0387V6.88701H96.8931V4.4077H98.8089V0.0125732H101.288V4.4077H115.175V6.88701H101.288V15.0387C101.288 16.9294 101.651 18.2693 102.365 19.0456Z" />
                  <path d="M129.037 4.40759H131.516V17.33C131.516 18.0688 131.378 18.7575 131.103 19.4086C130.827 20.0598 130.452 20.6232 129.963 21.0991C129.475 21.5749 128.911 21.9506 128.273 22.2386C127.634 22.514 126.933 22.6643 126.182 22.6643H122.4C121.336 22.6643 120.334 22.4639 119.395 22.0507C118.456 21.6375 117.642 21.0865 116.941 20.3853C116.239 19.6841 115.701 18.8702 115.3 17.9311C114.9 16.9919 114.699 15.9902 114.699 14.9133V4.40759H117.179V14.9133C117.179 15.6271 117.316 16.3158 117.592 16.9544C117.867 17.593 118.243 18.1565 118.719 18.6323C119.195 19.1081 119.758 19.4838 120.397 19.7718C121.035 20.0472 121.711 20.1975 122.438 20.1975H126.219C127.033 20.1975 127.709 19.922 128.248 19.3711C128.786 18.8201 129.049 18.1439 129.049 17.3425V4.40759H129.037Z" />
                  <path d="M147.431 0.0125732H149.91V22.6644H140.494C138.653 22.6644 137.2 22.1635 136.124 21.1618C135.047 20.1601 134.508 18.7952 134.508 17.0672V10.5684C134.508 9.71692 134.684 8.90301 135.034 8.1517C135.385 7.4004 135.861 6.73675 136.474 6.18579C137.088 5.63483 137.802 5.19657 138.628 4.87101C139.454 4.54544 140.331 4.39518 141.258 4.39518H147.431V0.0125732ZM147.431 6.87449H141.258C140.682 6.87449 140.131 6.97466 139.617 7.16249C139.104 7.36283 138.64 7.62579 138.252 7.96388C137.852 8.30196 137.539 8.70266 137.326 9.14092C137.1 9.5917 136.988 10.0675 136.988 10.5684V17.0672C136.988 18.0564 137.301 18.8202 137.914 19.3712C138.54 19.9096 139.404 20.1851 140.506 20.1851H147.431V6.87449Z" />
                  <path d="M156.61 1.28979C156.973 1.28979 157.298 1.41501 157.574 1.65293C157.849 1.89084 157.987 2.24145 157.987 2.69223C157.987 3.0804 157.849 3.40597 157.574 3.68145C157.298 3.95693 156.985 4.09466 156.61 4.09466C156.259 4.09466 155.933 3.95693 155.633 3.68145C155.332 3.40597 155.182 3.0804 155.182 2.69223C155.182 2.24145 155.332 1.90336 155.633 1.65293C155.933 1.41501 156.259 1.28979 156.61 1.28979ZM155.382 5.48458H157.862V22.6644H155.382V5.48458Z" />
                  <path d="M174.991 4.40759C175.667 4.40759 176.306 4.53281 176.907 4.79577C177.508 5.05872 178.034 5.42185 178.497 5.87264C178.948 6.32342 179.311 6.86185 179.587 7.47542C179.862 8.08898 180 8.72759 180 9.41629V15.5269C180 16.5161 179.812 17.4427 179.424 18.3067C179.036 19.1707 178.522 19.922 177.871 20.5606C177.22 21.1992 176.456 21.7126 175.592 22.0883C174.716 22.4639 173.802 22.6518 172.837 22.6518H167.841C167.165 22.6518 166.526 22.5266 165.925 22.2636C165.324 22.0006 164.798 21.65 164.36 21.1992C163.909 20.7485 163.559 20.2351 163.296 19.6215C163.033 19.0205 162.908 18.3819 162.908 17.7057V11.57C162.908 10.5808 163.096 9.6542 163.471 8.77768C163.847 7.90116 164.36 7.13733 164.999 6.4862C165.637 5.83507 166.389 5.32168 167.253 4.95855C168.117 4.59542 169.031 4.40759 169.995 4.40759H174.991ZM177.508 9.41629C177.508 8.71507 177.27 8.12655 176.782 7.62568C176.293 7.12481 175.705 6.8869 175.004 6.8869H169.97C169.331 6.8869 168.73 7.01212 168.167 7.26255C167.603 7.51298 167.115 7.85107 166.702 8.26429C166.289 8.67751 165.951 9.17838 165.713 9.75438C165.475 10.3304 165.349 10.9314 165.349 11.57V17.7057C165.349 18.0312 165.412 18.3568 165.537 18.6573C165.662 18.9579 165.838 19.2208 166.063 19.4462C166.289 19.6716 166.552 19.8469 166.852 19.9846C167.153 20.1224 167.478 20.185 167.829 20.185H172.837C173.476 20.185 174.09 20.0598 174.653 19.8219C175.229 19.5839 175.717 19.2459 176.143 18.8326C176.556 18.4194 176.895 17.9186 177.145 17.3426C177.395 16.7666 177.521 16.1655 177.521 15.5269V9.41629H177.508Z" />
                </svg>
              </div>
            </Link>
          </div>

          {/* Toggle Button in mobile */}
          <Button
            variant="ghost"
            size="icon"
            className="md:hidden"
            aria-label="Toggle Navigation"
            aria-controls="sidebar-menu"
            aria-expanded={navOpened}
            onClick={() => setNavOpened((prev) => !prev)}
          >
            {navOpened ? <IconX /> : <IconMenu2 />}
          </Button>
        </Layout.Header>

        {/* Navigation links */}
        <Nav
          id="sidebar-menu"
          className={`z-40 h-full flex-1 overflow-auto ${
            navOpened ? "max-h-screen" : "max-h-0 py-0 md:max-h-screen md:py-2"
          }`}
          closeNav={() => setNavOpened(false)}
          isCollapsed={isCollapsed}
          links={filteredLinks} // Pass filtered links here
        />

        {/* Scrollbar width toggle button */}
        <Button
          onClick={() => setIsCollapsed((prev) => !prev)}
          size="icon"
          variant="outline"
          className="absolute -right-5 top-1/2 z-50 hidden rounded-full md:inline-flex"
        >
          <IconChevronsLeft
            stroke={1.5}
            className={`h-5 w-5 ${isCollapsed ? "rotate-180" : ""}`}
          />
        </Button>
      </Layout>
    </aside>
  );
}
